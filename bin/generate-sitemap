#!/usr/bin/env python
# encoding: utf-8
from __future__ import absolute_import, print_function, unicode_literals

from configparser import RawConfigParser
from urllib.parse import urljoin
import os
import sys

from lxml import etree, html, objectify

from simple_cloud_site.files import find_html_files

TIMESTAMP_XPATHS = map(etree.XPath, ('//*[@itemprop="dateModified"]/@datetime',
                                     '//*[@itemprop="datePublished"]/@datetime',
                                     '//*[@itemprop="dateCreated"]/@datetime'))


def main():
    config = RawConfigParser()
    config.read([".simple-cloud-site.cfg"])

    source_dir = os.path.realpath(os.curdir)
    base_url = config.get('site', 'base_url')

    E = objectify.ElementMaker(annotate=False,
                               namespace=u'http://www.sitemaps.org/schemas/sitemap/0.9',
                               nsmap={None: u'http://www.sitemaps.org/schemas/sitemap/0.9'})

    urls = []
    for f in find_html_files(source_dir):
        path = os.path.relpath(f, start=source_dir)
        if path.endswith("index.html"):
            path = os.path.dirname(path)

        url = E.url(E.loc(urljoin(base_url, path)))

        with open(f, "r", encoding="utf8") as html_f:
            h = html.parse(html_f)

            for xpath in TIMESTAMP_XPATHS:
                res = xpath(h)
                if res:
                    url.append(E.lastmod(res[0]))
                    break

        urls.append(url)

    urlset = E.urlset(*urls)
    pretty_xml = etree.tostring(urlset, pretty_print=True)

    with open('sitemap.xml', 'wb') as f:
        f.write(pretty_xml)

if __name__ == "__main__":
    main()
